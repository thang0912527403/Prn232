<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - eBay Clone</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
            color: #e53238 !important;
        }

        .product-card {
            transition: transform 0.2s;
            height: 100%;
        }

            .product-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            }

        .status-badge {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
        }

        .timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            position: relative;
            padding-left: 40px;
            padding-bottom: 20px;
        }

            .timeline-item:before {
                content: '';
                position: absolute;
                left: 10px;
                top: 0;
                bottom: -20px;
                width: 2px;
                background: #dee2e6;
            }

            .timeline-item:last-child:before {
                display: none;
            }

        .timeline-marker {
            position: absolute;
            left: 0;
            top: 0;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0d6efd;
            border: 3px solid #fff;
            box-shadow: 0 0 0 3px #dee2e6;
        }

        .escrow-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .dropdown-user {
            min-width: 280px;
        }

        .user-info-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 0.375rem 0.375rem 0 0;
            margin: -0.5rem -0.5rem 0.5rem -0.5rem;
        }

        .trust-badge {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            font-size: 0.75rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shopping-cart"></i> eBay Clone
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </li>
                    <li class="nav-item" id="myOrdersLink" style="display: none;">
                        <a class="nav-link" href="/Home/MyOrders">
                            <i class="fas fa-box"></i> My Orders
                        </a>
                    </li>
                </ul>
                <form class="d-flex me-3">
                    <input class="form-control me-2" type="search" placeholder="Search products..." />
                    <button class="btn btn-outline-primary" type="submit">
                        <i class="fas fa-search"></i>
                    </button>
                </form>

                <!-- Menu khi chưa login -->
                <ul class="navbar-nav" id="guestMenu">
                    <li class="nav-item">
                        <a class="nav-link" href="/Account/Login">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link btn btn-primary text-white ms-2" href="/Account/Register">
                            <i class="fas fa-user-plus"></i> Sign Up
                        </a>
                    </li>
                </ul>

                <!-- Menu khi đã login -->
                <ul class="navbar-nav" id="userMenu" style="display: none;">
                    <li class="nav-item">
                        <a class="nav-link position-relative" href="/Cart">
                            <i class="fas fa-shopping-cart"></i> Cart
                            <span class="badge bg-danger" id="cartCount">0</span>
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown"
                           role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="user-avatar me-2" id="userAvatar">U</div>
                            <span id="userName">User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end dropdown-user" aria-labelledby="userDropdown">
                            <li>
                                <div class="user-info-header">
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar me-3" id="userAvatarDropdown" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                            U
                                        </div>
                                        <div class="flex-grow-1">
                                            <strong id="userNameDropdown">User Name</strong>
                                            <div class="small" id="userEmail">user@example.com</div>
                                            <div class="trust-badge">
                                                <i class="fas fa-shield-alt"></i> <span id="userTrustLevel">New</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-2 d-flex justify-content-between small">
                                        <span><i class="fas fa-star"></i> Rating: <strong id="userRating">4.5</strong></span>
                                        <span><i class="fas fa-shopping-bag"></i> Sales: <strong id="userSales">0</strong></span>
                                    </div>
                                </div>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="/Account/Profile">
                                    <i class="fas fa-user"></i> My Profile
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="/Home/MyOrders">
                                    <i class="fas fa-box"></i> My Orders
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="/Seller/Dashboard">
                                    <i class="fas fa-store"></i> Seller Dashboard
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="/Account/Settings">
                                    <i class="fas fa-cog"></i> Settings
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item text-danger" href="#" id="logoutBtn">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="py-4">
        @if (TempData["Success"] != null)
        {
            <div class="container">
                <div class="alert alert-success alert-dismissible fade show">
                    <i class="fas fa-check-circle"></i> @TempData["Success"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="container">
                <div class="alert alert-danger alert-dismissible fade show">
                    <i class="fas fa-exclamation-circle"></i> @TempData["Error"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
        }
        @RenderBody()
    </main>

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5><i class="fas fa-shopping-cart"></i> eBay Clone</h5>
                    <p class="text-muted">Your trusted online marketplace</p>
                </div>
                <div class="col-md-4">
                    <h6>Quick Links</h6>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-white-50">About Us</a></li>
                        <li><a href="#" class="text-white-50">Contact</a></li>
                        <li><a href="#" class="text-white-50">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6>Connect With Us</h6>
                    <a href="#" class="text-white me-3"><i class="fab fa-facebook fa-2x"></i></a>
                    <a href="#" class="text-white me-3"><i class="fab fa-twitter fa-2x"></i></a>
                    <a href="#" class="text-white"><i class="fab fa-instagram fa-2x"></i></a>
                </div>
            </div>
            <hr class="bg-white" />
            <p class="text-center text-muted mb-0">&copy; 2024 eBay Clone. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Kiểm tra trạng thái đăng nhập và cập nhật navbar
        function updateNavbar() {
            const token = localStorage.getItem('token');
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');

            const guestMenu = document.getElementById('guestMenu');
            const userMenu = document.getElementById('userMenu');
            const myOrdersLink = document.getElementById('myOrdersLink');

            if (token && userInfo.userId) {
                // Đã login - hiển thị user menu
                guestMenu.style.display = 'none';
                userMenu.style.display = 'flex';
                myOrdersLink.style.display = 'block';

                // Cập nhật thông tin user
                const initials = userInfo.userName ? userInfo.userName.charAt(0).toUpperCase() : 'U';
                document.getElementById('userAvatar').textContent = initials;
                document.getElementById('userAvatarDropdown').textContent = initials;
                document.getElementById('userName').textContent = userInfo.userName || 'User';
                document.getElementById('userNameDropdown').textContent = userInfo.userName || 'User';
                document.getElementById('userEmail').textContent = userInfo.email || '';
                document.getElementById('userTrustLevel').textContent = userInfo.trustLevel || 'New';
                document.getElementById('userRating').textContent = userInfo.rating || '0.0';
                document.getElementById('userSales').textContent = userInfo.totalSales || '0';
            } else {
                // Chưa login - hiển thị guest menu
                guestMenu.style.display = 'flex';
                userMenu.style.display = 'none';
                myOrdersLink.style.display = 'none';
            }
        }

        // Logout function
        document.getElementById('logoutBtn')?.addEventListener('click', function(e) {
            e.preventDefault();

            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('userInfo');
                window.location.href = '/Account/Login';
            }
        });

        // Hàm để thêm token vào các request API
        function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('token');

            if (token) {
                options.headers = {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`
                };
            }

            return fetch(url, options);
        }

        // Gọi updateNavbar khi trang load
        document.addEventListener('DOMContentLoaded', updateNavbar);

        // Lắng nghe sự kiện storage để cập nhật navbar khi localStorage thay đổi
        window.addEventListener('storage', updateNavbar);
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
<script>
    // Sync localStorage to cookie để server có thể đọc
    function syncAuthToCookie() {
        const token = localStorage.getItem('token');
        const userInfo = localStorage.getItem('userInfo');

        if (token && userInfo) {
            const user = JSON.parse(userInfo);

            // Set cookies với expiry 7 ngày
            const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toUTCString();
            document.cookie = `token=${token}; expires=${expires}; path=/; SameSite=Lax`;
            document.cookie = `userId=${user.userId}; expires=${expires}; path=/; SameSite=Lax`;
        } else {
            // Xóa cookies nếu không có token
            document.cookie = 'token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = 'userId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        }
    }

    // Gọi khi trang load
    syncAuthToCookie();

    // Sync lại khi localStorage thay đổi
    window.addEventListener('storage', syncAuthToCookie);
</script>