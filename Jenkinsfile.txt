pipeline {
    agent any
    
    environment {
        DOTNET_VERSION = '8.0'
        DOCKER_REGISTRY = 'docker.io'
        IMAGE_NAME_API = 'ebayclone/api'
        IMAGE_NAME_WEB = 'ebayclone/web'
        DOCKER_CREDENTIALS = credentials('docker-hub-credentials')
        KUBE_CONFIG = credentials('kubernetes-config')
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 1, unit: 'HOURS')
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()
                }
            }
        }
        
        stage('Build') {
            steps {
                script {
                    sh '''
                        dotnet restore EbayClone.API/EbayClone.API.csproj
                        dotnet restore EbayClone.Web/EbayClone.Web.csproj
                        
                        dotnet build EbayClone.API/EbayClone.API.csproj \
                            --configuration Release --no-restore
                        dotnet build EbayClone.Web/EbayClone.Web.csproj \
                            --configuration Release --no-restore
                    '''
                }
            }
        }
        
        stage('Unit Tests') {
            steps {
                script {
                    sh '''
                        dotnet test --no-restore --verbosity normal \
                            --logger "trx;LogFileName=test-results.trx" \
                            --collect:"XPlat Code Coverage"
                    '''
                }
            }
            post {
                always {
                    mstest testResultsFile: '**/test-results.trx'
                    publishCoverage adapters: [
                        coberturaAdapter('**/coverage.cobertura.xml')
                    ]
                }
            }
        }
        
        stage('Code Quality Analysis') {
            parallel {
                stage('SonarQube') {
                    steps {
                        script {
                            withSonarQubeEnv('SonarQube') {
                                sh '''
                                    dotnet sonarscanner begin \
                                        /k:"ebayclone" \
                                        /d:sonar.host.url="${SONAR_HOST_URL}" \
                                        /d:sonar.login="${SONAR_AUTH_TOKEN}"
                                    
                                    dotnet build
                                    
                                    dotnet sonarscanner end \
                                        /d:sonar.login="${SONAR_AUTH_TOKEN}"
                                '''
                            }
                        }
                    }
                }
                
                stage('Security Scan') {
                    steps {
                        script {
                            sh '''
                                # OWASP Dependency Check
                                dependency-check.sh --project "eBay Clone" \
                                    --scan . --format HTML --format JSON
                                
                                # Trivy vulnerability scan
                                trivy fs --severity HIGH,CRITICAL \
                                    --format json --output trivy-report.json .
                            '''
                        }
                    }
                }
            }
        }
        
        stage('Build Docker Images') {
            when {
                branch 'main'
            }
            steps {
                script {
                    sh '''
                        # Build API image
                        docker build -t ${IMAGE_NAME_API}:${GIT_COMMIT_SHORT} \
                            -t ${IMAGE_NAME_API}:latest \
                            -f EbayClone.API/Dockerfile .
                        
                        # Build Web image
                        docker build -t ${IMAGE_NAME_WEB}:${GIT_COMMIT_SHORT} \
                            -t ${IMAGE_NAME_WEB}:latest \
                            -f EbayClone.Web/Dockerfile .
                    '''
                }
            }
        }
        
        stage('Push Docker Images') {
            when {
                branch 'main'
            }
            steps {
                script {
                    sh '''
                        echo ${DOCKER_CREDENTIALS_PSW} | docker login -u ${DOCKER_CREDENTIALS_USR} --password-stdin
                        
                        docker push ${IMAGE_NAME_API}:${GIT_COMMIT_SHORT}
                        docker push ${IMAGE_NAME_API}:latest
                        
                        docker push ${IMAGE_NAME_WEB}:${GIT_COMMIT_SHORT}
                        docker push ${IMAGE_NAME_WEB}:latest
                        
                        docker logout
                    '''
                }
            }
        }
        
        stage('Deploy to Staging') {
            when {
                branch 'develop'
            }
            steps {
                script {
                    sh '''
                        kubectl --kubeconfig=${KUBE_CONFIG} apply -f k8s-deployment.yaml -n staging
                        
                        kubectl --kubeconfig=${KUBE_CONFIG} rollout status \
                            deployment/ebay-api -n staging --timeout=5m
                        
                        kubectl --kubeconfig=${KUBE_CONFIG} rollout status \
                            deployment/ebay-web -n staging --timeout=5m
                    '''
                }
            }
        }
        
        stage('Performance Testing') {
            when {
                branch 'develop'
            }
            steps {
                script {
                    sh '''
                        # Run JMeter tests
                        jmeter -n -t tests/load-test.jmx \
                            -l results/jmeter-results.jtl \
                            -e -o results/jmeter-report \
                            -Jhostname=staging.ebayclone.com \
                            -Jthreads=100 \
                            -Jrampup=60 \
                            -Jduration=300
                    '''
                }
            }
            post {
                always {
                    perfReport sourceDataFiles: 'results/jmeter-results.jtl',
                        errorFailedThreshold: 5,
                        errorUnstableThreshold: 2
                    publishHTML([
                        reportDir: 'results/jmeter-report',
                        reportFiles: 'index.html',
                        reportName: 'JMeter Performance Report'
                    ])
                }
            }
        }
        
        stage('Security Testing') {
            when {
                branch 'develop'
            }
            steps {
                script {
                    sh '''
                        # OWASP ZAP security scan
                        docker run -t owasp/zap2docker-stable zap-baseline.py \
                            -t https://staging.ebayclone.com \
                            -r zap-report.html \
                            -J zap-report.json
                    '''
                }
            }
        }
        
        stage('Deploy to Production') {
            when {
                branch 'main'
            }
            steps {
                input message: 'Deploy to Production?', ok: 'Deploy'
                
                script {
                    sh '''
                        # Blue-Green Deployment
                        kubectl --kubeconfig=${KUBE_CONFIG} set image \
                            deployment/ebay-api ebay-api=${IMAGE_NAME_API}:${GIT_COMMIT_SHORT} \
                            -n production
                        
                        kubectl --kubeconfig=${KUBE_CONFIG} set image \
                            deployment/ebay-web ebay-web=${IMAGE_NAME_WEB}:${GIT_COMMIT_SHORT} \
                            -n production
                        
                        # Wait for rollout
                        kubectl --kubeconfig=${KUBE_CONFIG} rollout status \
                            deployment/ebay-api -n production --timeout=10m
                        
                        kubectl --kubeconfig=${KUBE_CONFIG} rollout status \
                            deployment/ebay-web -n production --timeout=10m
                        
                        # Health check
                        sleep 30
                        curl -f https://ebayclone.com/health || exit 1
                    '''
                }
            }
        }
        
        stage('Smoke Tests') {
            when {
                branch 'main'
            }
            steps {
                script {
                    sh '''
                        # Run smoke tests against production
                        dotnet test tests/SmokeTests/SmokeTests.csproj \
                            --configuration Release \
                            --logger "trx;LogFileName=smoke-test-results.trx" \
                            -- TestRunParameters.Parameter(name="BaseUrl", value="https://ebayclone.com")
                    '''
                }
            }
        }
    }
    
    post {
        success {
            script {
                if (env.BRANCH_NAME == 'main') {
                    slackSend(
                        color: 'good',
                        message: "✅ Production deployment successful!\nCommit: ${env.GIT_COMMIT_SHORT}\nBuild: ${env.BUILD_URL}"
                    )
                }
            }
        }
        
        failure {
            script {
                slackSend(
                    color: 'danger',
                    message: "❌ Build failed!\nBranch: ${env.BRANCH_NAME}\nCommit: ${env.GIT_COMMIT_SHORT}\nBuild: ${env.BUILD_URL}"
                )
            }
        }
        
        always {
            cleanWs()
        }
    }
}